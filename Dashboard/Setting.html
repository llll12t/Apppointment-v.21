<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap"
        rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-thai {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .table-scroll-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .table-scroll-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            /* slate-300 */
            border-radius: 3px;
        }

        .table-scroll-container::-webkit-scrollbar-track {
            background-color: #f1f5f9;
            /* slate-100 */
        }

        .hidden {
            display: none !important;
        }

        .loading-placeholder td {
            text-align: center;
            padding: 1rem;
            color: #64748b;
            /* slate-500 */
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-white p-5 border-r border-slate-200 flex flex-col fixed inset-y-0 left-0 z-30">
        <div class="flex items-center space-x-2 mb-8">
            <div class="bg-indigo-600 p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <h1 class="text-xl font-bold text-slate-800">BookingApp‚Ñ¢</h1>
        </div>
        <!-- ===================================================================
            (B) ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage.adminName)
            =================================================================== -->
        <div class="bg-slate-50 p-3 rounded-lg mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div>
                        <p id="adminName" class="text-sm font-semibold text-slate-700 font-thai">Dashboard User</p>
                        <p class="text-xs text-slate-500 font-thai">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    </div>
                </div>
                <!-- ‡∏õ‡∏∏‡πà‡∏° Logout -->
                <button onclick="logout()" class="text-red-500 hover:text-red-700 text-sm font-thai">
                    logout
                </button>
            </div>
        </div>
        <nav class="flex-grow space-y-1">
            <p class="text-xs text-slate-400 uppercase font-semibold px-3 mb-2">Main Menu</p>
            <a href="book.html"
                class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-indigo-700 rounded-md text-sm font-medium font-thai">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>
            </a>
            <a href="Apppointment.html"
                class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-indigo-700 rounded-md text-sm font-medium font-thai">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</span></a>
            <a href="service.html"
                class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-indigo-700 rounded-md text-sm font-medium font-thai">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <span>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
            </a>
            <a href="member.html"
                class="flex items-center space-x-3 px-3 py-2.5 text-slate-600 hover:bg-indigo-50 hover:text-indigo-700 rounded-md text-sm font-medium font-thai">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
            </a>
            <a href="setting.html"
                class="flex items-center space-x-3 px-3 py-2.5 bg-indigo-100 text-indigo-700 rounded-md text-sm font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 flex-1 flex flex-col">
        <header class="bg-white border-b border-slate-200 p-4 flex items-center justify-between sticky top-0 z-20">
            <h1 class="text-xl font-semibold text-slate-700 font-thai">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h1>
            <div class="flex items-center space-x-4">
                <button class="text-slate-500 hover:text-slate-700 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                </button>
                <img src="https://i.pravatar.cc/40?u=admin" alt="Admin" class="w-8 h-8 rounded-full">
            </div>
        </header>

        <div class="flex-1 p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">

            <!-- Branch Settings Card (NEW SECTION) -->
            <section class="bg-white p-6 rounded-lg shadow col-span-1 xl:col-span-1">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-slate-700 font-thai">üè¢ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤</h2>
                    <button onclick="showBranchForm()"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-3 rounded-md text-sm flex items-center space-x-1.5 font-thai">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                clip-rule="evenodd" />
                        </svg>
                        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</span>
                    </button>
                </div>
                <div id="branchFormSection" class="hidden mb-4 border-t border-slate-200 pt-4">
                    <form id="branchForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="branch-id"
                                class="block text-xs font-medium text-slate-600 font-thai">‡πÑ‡∏≠‡∏î‡∏µ</label>
                            <input id="branch-id" name="‡πÑ‡∏≠‡∏î‡∏µ"
                                class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm"
                                placeholder="‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏´‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)">
                        </div>
                        <div>
                            <label for="branch-name" class="block text-xs font-medium text-slate-600 font-thai">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
                                <span class="text-red-500">*</span></label>
                            <input id="branch-name" name="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤" type="text" required
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏≠‡∏Å‡∏°‡∏±‡∏¢">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="branch-calendar-id"
                                class="block text-xs font-medium text-slate-600 font-thai">Google Calendar ID</label>
                            <input id="branch-calendar-id" name="Google Calendar ID" type="text"
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô example@group.calendar.google.com">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="branch-supported-services"
                                class="block text-xs font-medium text-slate-600 font-thai">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢
                                ,)</label>
                            <input id="branch-supported-services" name="‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö" type="text"
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏ß‡∏î‡πÑ‡∏ó‡∏¢, ‡∏ó‡∏≥‡πÄ‡∏•‡πá‡∏ö">
                        </div>
                        <div>
                            <label for="branch-open-time"
                                class="block text-xs font-medium text-slate-600 font-thai">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</label>
                            <input id="branch-open-time" name="‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£" type="time"
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="branch-close-time"
                                class="block text-xs font-medium text-slate-600 font-thai">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</label>
                            <input id="branch-close-time" name="‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£" type="time"
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="sm:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" onclick="hideBranchForm()"
                                class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-2 px-3 rounded-md text-sm font-thai">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit"
                                class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-md text-sm flex items-center space-x-1.5 font-thai">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path
                                        d="M7.5 1C6.11929 1 5 2.11929 5 3.5V4H4C3.44772 4 3 4.44772 3 5V17C3 17.5523 3.44772 18 4 18H16C16.5523 18 17 17.5523 17 17V5C17 4.44772 16.5523 4 16 4H15V3.5C15 2.11929 13.8807 1 12.5 1H7.5ZM7 3.5C7 3.22386 7.22386 3 7.5 3H12.5C12.7761 3 13 3.22386 13 3.5V4H7V3.5Z M6 6H14V16H6V6Z" />
                                </svg>
                                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                            </button>
                        </div>
                    </form>
                </div>
                <div id="branchTableContainer" class="overflow-x-auto table-scroll-container">
                    <!-- Loading message will be injected here by JS -->
                </div>
            </section>

            <!-- Time Slot Settings Card -->
            <section class="bg-white p-6 rounded-lg shadow col-span-1 lg:col-span-2 xl:col-span-1">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-slate-700 font-thai">‚è±Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
                    <button onclick="showTimeSlotForm()"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-3 rounded-md text-sm flex items-center space-x-1.5 font-thai">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                clip-rule="evenodd" />
                        </svg>
                        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>
                    </button>
                </div>
                <div id="timeSlotFormSection" class="hidden mb-4 border-t border-slate-200 pt-4">
                    <form id="timeSlotForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="ts-id" class="block text-xs font-medium text-slate-600 font-thai">‡πÑ‡∏≠‡∏î‡∏µ</label>
                            <input id="ts-id" name="‡πÑ‡∏≠‡∏î‡∏µ"
                                class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm"
                                placeholder="‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏´‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)">
                        </div>
                        <div>
                            <label for="ts-branch-id" class="block text-xs font-medium text-slate-600 font-thai">‡∏™‡∏≤‡∏Ç‡∏≤
                                <span class="text-red-500">*</span></label>
                            <select id="ts-branch-id" name="‡∏™‡∏≤‡∏Ç‡∏≤ ID" required
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                            </select>
                        </div>
                        <div>
                            <label for="ts-time" class="block text-xs font-medium text-slate-600 font-thai">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
                                <span class="text-red-500">*</span></label>
                            <input id="ts-time" name="‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤" type="time" required
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="ts-slots" class="block text-xs font-medium text-slate-600 font-thai">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏•‡πá‡∏≠‡∏ï
                                <span class="text-red-500">*</span></label>
                            <input id="ts-slots" name="‡∏™‡∏•‡∏≠‡∏ï" type="number" min="1" required
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô 1">
                        </div>
                        <div class="sm:col-span-2 flex justify-end space-x-2 mt-2">
                            <button type="button" onclick="hideTimeSlotForm()"
                                class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium py-2 px-3 rounded-md text-sm font-thai">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit"
                                class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-md text-sm flex items-center space-x-1.5 font-thai">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path
                                        d="M7.5 1C6.11929 1 5 2.11929 5 3.5V4H4C3.44772 4 3 4.44772 3 5V17C3 17.5523 3.44772 18 4 18H16C16.5523 18 17 17.5523 17 17V5C17 4.44772 16.5523 4 16 4H15V3.5C15 2.11929 13.8807 1 12.5 1H7.5ZM7 3.5C7 3.22386 7.22386 3 7.5 3H12.5C12.7761 3 13 3.22386 13 3.5V4H7V3.5Z M6 6H14V16H6V6Z" />
                                </svg>
                                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                            </button>
                        </div>
                    </form>
                </div>
                <div id="timeSlotTableContainer" class="overflow-x-auto table-scroll-container">
                    <!-- Loading message will be injected here by JS -->
                </div>
            </section>

            <!-- Holiday Settings Card -->
            <section class="bg-white p-6 rounded-lg shadow col-span-1 lg:col-span-2 xl:col-span-1">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-slate-700 font-thai">üóìÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 items-end">
                    <div>
                        <label for="holidayInput"
                            class="block text-xs font-medium text-slate-600 font-thai">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                            <span class="text-red-500">*</span></label>
                        <input id="holidayInput" type="date" required
                            class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="holidayName"
                            class="block text-xs font-medium text-slate-600 font-thai">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</label>
                        <input id="holidayName" type="text"
                            class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="holidayBranchId" class="block text-xs font-medium text-slate-600 font-thai">‡∏™‡∏≤‡∏Ç‡∏≤
                            <span class="text-red-500">*</span></label>
                        <select id="holidayBranchId" required
                            class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 flex justify-end">
                        <button onclick="addHoliday()"
                            class="w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-3 rounded-md text-sm flex items-center justify-center space-x-1.5 font-thai">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
                        </button>
                    </div>
                </div>
                <div id="holidayTableContainer" class="overflow-x-auto table-scroll-container">
                    <!-- Loading message will be injected here by JS -->
                </div>
            </section>
        </div>
    </main>
  <!-- Assume Config.js defines WEB_APP_URL -->
  <script src="Config.js"></script>
    <script>
        // (A) ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏à‡∏≤‡∏Å localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const adminName = localStorage.getItem('adminName') || 'Admin';
            document.getElementById('adminName').textContent = adminName;
        });

        // (B) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Logout: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå localStorage ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login.html
        function logout() {
            localStorage.removeItem('isAdminLoggedIn');
            localStorage.removeItem('adminName');
            window.location.href = 'login.html';
        }
        const branchTableContainer = document.getElementById('branchTableContainer');
        const timeSlotTableContainer = document.getElementById('timeSlotTableContainer');
        const holidayTableContainer = document.getElementById('holidayTableContainer');

        let branchesData = []; // To store branch data for dropdowns

        const loadingHTML = `
        <table class="min-w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50"><tr><th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th></tr></thead>
            <tbody class="bg-white divide-y divide-slate-200">
                <tr class="loading-placeholder"><td class="font-thai">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
        </table>`;

        // Utility function for API calls (*** ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ***)
        async function fetchData(action, body = null) {
            try {
                let url = CONFIG_URL; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Web App
                const options = {
                    method: 'GET' // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î method ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô GET
                };

                if (body) { // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ body (‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πá‡∏ô POST request)
                    options.method = 'POST';
                    // *** ‡πÄ‡∏û‡∏¥‡πà‡∏° 'action' ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô body payload ***
                    const payload = { ...body, action: action }; // ‡∏£‡∏ß‡∏° action ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô object ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö body
                    options.body = JSON.stringify(payload);
                } else { // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ body (‡∏Ñ‡∏∑‡∏≠ GET request)
                    url += `?action=${action}`; // ‡πÄ‡∏û‡∏¥‡πà‡∏° action ‡πÄ‡∏õ‡πá‡∏ô query parameter ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GET
                }

                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error in fetchData for action ${action}:`, error);
                throw error;
            }
        }

        // --- Shared UI Functions ---
        function showLoadingSwal(title = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...') {
            Swal.fire({
                title: title,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading(),
                customClass: {
                    popup: 'font-thai'
                }
            });
        }

        function showSuccessSwal(message = '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') {
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                text: message,
                customClass: {
                    popup: 'font-thai'
                }
            });
        }

        function showErrorSwal(message = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î') {
            Swal.fire({
                icon: 'error',
                title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                text: message,
                customClass: {
                    popup: 'font-thai'
                }
            });
        }

        async function populateBranchDropdowns() {
            const timeSlotBranchSelect = document.getElementById('ts-branch-id');
            const holidayBranchSelect = document.getElementById('holidayBranchId');

            // Clear existing options
            timeSlotBranchSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
            holidayBranchSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';

            if (branchesData.length === 0) {
                const optionTS = document.createElement('option');
                optionTS.value = '';
                optionTS.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤)';
                optionTS.disabled = true;
                timeSlotBranchSelect.appendChild(optionTS);

                const optionHoliday = document.createElement('option');
                optionHoliday.value = '';
                optionHoliday.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤)';
                optionHoliday.disabled = true;
                holidayBranchSelect.appendChild(optionHoliday);

                timeSlotBranchSelect.disabled = true;
                holidayBranchSelect.disabled = true;
                return;
            }

            timeSlotBranchSelect.disabled = false;
            holidayBranchSelect.disabled = false;

            branchesData.forEach(branch => {
                const optionTS = document.createElement('option');
                optionTS.value = branch['‡πÑ‡∏≠‡∏î‡∏µ'];
                optionTS.textContent = `${branch['‡πÑ‡∏≠‡∏î‡∏µ']} - ${branch['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤']}`;
                timeSlotBranchSelect.appendChild(optionTS);

                const optionHoliday = document.createElement('option');
                optionHoliday.value = branch['‡πÑ‡∏≠‡∏î‡∏µ'];
                optionHoliday.textContent = `${branch['‡πÑ‡∏≠‡∏î‡∏µ']} - ${branch['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤']}`;
                holidayBranchSelect.appendChild(optionHoliday);
            });
        }

        function getBranchNameById(id) {
            const branch = branchesData.find(b => b['‡πÑ‡∏≠‡∏î‡∏µ'] === id);
            return branch ? branch['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤'] : `ID: ${id} (‡πÑ‡∏°‡πà‡∏û‡∏ö)`;
        }


        // --- Branch Management ---
        function showBranchForm(isEdit = false) {
            document.getElementById('branchFormSection').classList.remove('hidden');
            if (!isEdit) {
                document.getElementById('branchForm').reset();
                document.getElementById('branch-id').value = ''; // Reset ID field for new entry
                document.getElementById('branch-id').readOnly = false; // Allow manual ID input for new, can remove if auto-gen is strict
                document.getElementById('branch-id').classList.remove('bg-slate-50'); // Remove gray background
            } else {
                document.getElementById('branch-id').readOnly = true; // Make ID read-only when editing
                document.getElementById('branch-id').classList.add('bg-slate-50'); // Add gray background
            }
            document.getElementById('branchFormSection').scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
            });
        }

        function hideBranchForm() {
            document.getElementById('branchFormSection').classList.add('hidden');
            document.getElementById('branchForm').reset();
        }

        document.getElementById('branchForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const data = {};
            new FormData(this).forEach((value, key) => data[key] = value);

            showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤...');
            try {
                const result = await fetchData('insertOrUpdateBranch', { data });
                if (result.success) {
                    showSuccessSwal(result.message);
                    this.reset();
                    hideBranchForm();
                    await loadBranches(); // Reload data after successful operation
                } else {
                    showErrorSwal(result.message);
                }
            } catch (error) {
                showErrorSwal(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            }
        });

        async function loadBranches() {
            branchTableContainer.innerHTML = loadingHTML;
            try {
                const data = await fetchData('fetchBranches');
                branchesData = data; // Store data for dropdowns
                populateBranchDropdowns(); // Update all dropdowns

                let html = `
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50"><tr>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡πÑ‡∏≠‡∏î‡∏µ</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">Google Calendar ID</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr></thead><tbody class="bg-white divide-y divide-slate-200">`;

                if (data.length === 0) {
                    html += `<tr><td colspan="5" class="px-3 py-3 text-center text-slate-500 font-thai">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤</td></tr>`;
                } else {
                    data.forEach(b => {
                        html += `<tr class="hover:bg-slate-50">
                            <td class="px-3 py-3 whitespace-nowrap text-slate-600 font-mono text-xs">${b['‡πÑ‡∏≠‡∏î‡∏µ']}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700 font-medium">${b['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤']}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700 text-xs">${b['Google Calendar ID']}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700 text-xs">${b['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£'] || '-'} - ${b['‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£'] || '-'}</td>
                            <td class="px-3 py-3 whitespace-nowrap">
                                <button onclick="editBranch('${b['‡πÑ‡∏≠‡∏î‡∏µ']}')" class="text-indigo-600 hover:text-indigo-900 mr-2 font-thai">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button onclick="deleteBranch('${b['‡πÑ‡∏≠‡∏î‡∏µ']}')" class="text-red-600 hover:text-red-900 font-thai">‡∏•‡∏ö</button>
                            </td>
                        </tr>`;
                    });
                }
                html += '</tbody></table>';
                branchTableContainer.innerHTML = html;
            } catch (error) {
                branchTableContainer.innerHTML = `<p class="p-3 text-red-500 font-thai">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}</p>`;
                populateBranchDropdowns(); // Still try to populate dropdowns even if table load fails
            }
        }

        async function editBranch(id) {
            showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤...');
            try {
                // Fetch data again to ensure it's fresh, or use `branchesData.find` if `branchesData` is guaranteed to be up-to-date
                const data = await fetchData('fetchBranches');
                const branch = data.find(x => x['‡πÑ‡∏≠‡∏î‡∏µ'] === id);
                Swal.close();
                if (!branch) {
                    return showErrorSwal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤');
                }
                const form = document.getElementById('branchForm');
                form.elements['‡πÑ‡∏≠‡∏î‡∏µ'].value = branch['‡πÑ‡∏≠‡∏î‡∏µ'];
                form.elements['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤'].value = branch['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤'];
                form.elements['Google Calendar ID'].value = branch['Google Calendar ID'];
                form.elements['‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'].value = branch['‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'];
                form.elements['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£'].value = branch['‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£'];
                form.elements['‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£'].value = branch['‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£'];
                showBranchForm(true); // true means it's an edit
            } catch (error) {
                showErrorSwal(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            }
        }

        async function deleteBranch(id) {
            const result = await Swal.fire({
                title: '‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ?',
                html: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏≠‡∏î‡∏µ: <strong>${id}</strong> ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br><span class="text-red-500 text-sm">‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                customClass: {
                    popup: 'font-thai'
                }
            });

            if (result.isConfirmed) {
                showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤...');
                try {
                    const deleteResult = await fetchData('deleteBranch', { id });
                    if (deleteResult.success) {
                        showSuccessSwal(deleteResult.message);
                        await loadBranches();
                        // Also reload time slots and holidays in case branches were affected
                        await loadTimeSlots();
                        await loadHolidays();
                    } else {
                        showErrorSwal(deleteResult.message);
                    }
                } catch (error) {
                    showErrorSwal(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
                }
            }
        }


        // --- Time Slot Management ---
        function showTimeSlotForm(isEdit = false) {
            document.getElementById('timeSlotFormSection').classList.remove('hidden');
            if (!isEdit) {
                document.getElementById('timeSlotForm').reset();
                document.getElementById('ts-id').value = ''; // Reset ID field for new entry
                document.getElementById('ts-id').readOnly = false; // Allow manual ID input for new
                document.getElementById('ts-id').classList.remove('bg-slate-50');
                // Ensure branch dropdown is reset for new entry
                document.getElementById('ts-branch-id').value = '';
            } else {
                document.getElementById('ts-id').readOnly = true; // Make ID read-only when editing
                document.getElementById('ts-id').classList.add('bg-slate-50');
            }
            document.getElementById('timeSlotFormSection').scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
            });
        }

        function hideTimeSlotForm() {
            document.getElementById('timeSlotFormSection').classList.add('hidden');
            document.getElementById('timeSlotForm').reset();
        }

        document.getElementById('timeSlotForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const data = {};
            new FormData(this).forEach((value, key) => data[key] = value);

            showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤...');
            try {
                const result = await fetchData('insertOrUpdateTimeSlot', { data });
                if (result.success) {
                    showSuccessSwal(result.message);
                    this.reset();
                    hideTimeSlotForm();
                    await loadTimeSlots(); // Reload data after successful operation
                } else {
                    showErrorSwal(result.message);
                }
            } catch (error) {
                showErrorSwal(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            }
        });

        async function loadTimeSlots() {
            timeSlotTableContainer.innerHTML = loadingHTML;
            try {
                const data = await fetchData('fetchTimeSlots');
                let html = `
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50"><tr>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡πÑ‡∏≠‡∏î‡∏µ</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏•‡πá‡∏≠‡∏ï</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr></thead><tbody class="bg-white divide-y divide-slate-200">`;

                if (data.length === 0) {
                    html += `<tr><td colspan="5" class="px-3 py-3 text-center text-slate-500 font-thai">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</td></tr>`;
                } else {
                    data.forEach(t => {
                        html += `<tr class="hover:bg-slate-50">
                            <td class="px-3 py-3 whitespace-nowrap text-slate-600 font-mono text-xs">${t['‡πÑ‡∏≠‡∏î‡∏µ']}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700 font-medium">${getBranchNameById(t['‡∏™‡∏≤‡∏Ç‡∏≤ ID'])}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700 font-medium">${t['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤']}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700">${t['‡∏™‡∏•‡∏≠‡∏ï']}</td>
                            <td class="px-3 py-3 whitespace-nowrap">
                                <button onclick="editTimeSlot('${t['‡πÑ‡∏≠‡∏î‡∏µ']}')" class="text-indigo-600 hover:text-indigo-900 mr-2 font-thai">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button onclick="deleteTimeSlot('${t['‡πÑ‡∏≠‡∏î‡∏µ']}')" class="text-red-600 hover:text-red-900 font-thai">‡∏•‡∏ö</button>
                            </td>
                        </tr>`;
                    });
                }
                html += '</tbody></table>';
                timeSlotTableContainer.innerHTML = html;
            } catch (error) {
                timeSlotTableContainer.innerHTML = `<p class="p-3 text-red-500 font-thai">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}</p>`;
            }
        }

        async function editTimeSlot(id) {
            showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤...');
            try {
                const data = await fetchData('fetchTimeSlots');
                const t = data.find(x => x['‡πÑ‡∏≠‡∏î‡∏µ'] === id);
                Swal.close();
                if (!t) {
                    return showErrorSwal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤');
                }
                const form = document.getElementById('timeSlotForm');
                form.elements['‡πÑ‡∏≠‡∏î‡∏µ'].value = t['‡πÑ‡∏≠‡∏î‡∏µ'];
                form.elements['‡∏™‡∏≤‡∏Ç‡∏≤ ID'].value = t['‡∏™‡∏≤‡∏Ç‡∏≤ ID'];
                form.elements['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤'].value = t['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤'];
                form.elements['‡∏™‡∏•‡∏≠‡∏ï'].value = t['‡∏™‡∏•‡∏≠‡∏ï'];
                showTimeSlotForm(true); // true means it's an edit
            } catch (error) {
                showErrorSwal(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            }
        }

        async function deleteTimeSlot(id) {
            const result = await Swal.fire({
                title: '‡∏•‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ?',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏≠‡∏î‡∏µ: ${id}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                customClass: {
                    popup: 'font-thai'
                }
            });

            if (result.isConfirmed) {
                showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤...');
                try {
                    const deleteResult = await fetchData('deleteTimeSlot', { id });
                    if (deleteResult.success) {
                        showSuccessSwal(deleteResult.message);
                        await loadTimeSlots(); // Reload data after successful operation
                    } else {
                        showErrorSwal(deleteResult.message);
                    }
                } catch (error) {
                    showErrorSwal(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
                }
            }
        }


        // --- Holiday Management ---
        async function addHoliday() {
            const date = document.getElementById('holidayInput').value;
            const name = document.getElementById('holidayName').value;
            const branchId = document.getElementById('holidayBranchId').value;

            if (!date || !branchId) {
                return showErrorSwal('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î');
            }

            showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î...');
            try {
                const result = await fetchData('addHoliday', { data: { ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: date, ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î: name, '‡∏™‡∏≤‡∏Ç‡∏≤ ID': branchId } });
                if (result.success) {
                    showSuccessSwal(result.message);
                    document.getElementById('holidayInput').value = '';
                    document.getElementById('holidayName').value = '';
                    document.getElementById('holidayBranchId').value = ''; // Reset dropdown
                    await loadHolidays(); // Reload data after successful operation
                } else {
                    showErrorSwal(result.message);
                }
            } catch (error) {
                showErrorSwal(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            }
        }


        async function loadHolidays() {
            holidayTableContainer.innerHTML = loadingHTML;
            try {
                const data = await fetchData('fetchHolidays');
                let html = `
                <table class="min-w-full divide-y divide-slate-200 text-sm">
                    <thead class="bg-slate-50"><tr>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                    <th class="px-3 py-2.5 text-left text-xs font-medium text-slate-500 uppercase tracking-wider font-thai">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr></thead><tbody class="bg-white divide-y divide-slate-200">`;

                if (data.length === 0) {
                    html += `<tr><td colspan="4" class="px-3 py-3 text-center text-slate-500 font-thai">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</td></tr>`;
                } else {
                    data.forEach(d => {
                        html += `<tr class="border-t hover:bg-slate-50">
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700 font-medium">${d['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700">${d['‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î'] || '-'}</td>
                            <td class="px-3 py-3 whitespace-nowrap text-slate-700 font-medium">${getBranchNameById(d['‡∏™‡∏≤‡∏Ç‡∏≤ ID'])}</td>
                            <td class="px-3 py-3 whitespace-nowrap">
                                <button onclick="deleteHoliday('${d['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}', '${d['‡∏™‡∏≤‡∏Ç‡∏≤ ID']}')" class="text-red-600 hover:text-red-900 font-thai">‡∏•‡∏ö</button>
                            </td>
                        </tr>`;
                    });
                }
                html += '</tbody></table>';
                holidayTableContainer.innerHTML = html;
            } catch (error) {
                holidayTableContainer.innerHTML = `<p class="p-3 text-red-500 font-thai">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}</p>`;
            }
        }


        async function deleteHoliday(date, branchId) {
            const result = await Swal.fire({
                title: `‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ${date} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${getBranchNameById(branchId)}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                customClass: {
                    popup: 'font-thai'
                }
            });

            if (result.isConfirmed) {
                showLoadingSwal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î...');
                try {
                    // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏á date ‡πÅ‡∏•‡∏∞ branchId ‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÜ ***
                    const deleteResult = await fetchData('deleteHoliday', { date: date, branchId: branchId });
                    if (deleteResult.success) {
                        showSuccessSwal(deleteResult.message);
                        await loadHolidays(); // Reload data after successful operation
                    } else {
                        showErrorSwal(deleteResult.message);
                    }
                } catch (error) {
                    showErrorSwal(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
                }
            }
        }

        // Initial Load of all data
        // Load branches first, then time slots and holidays
        document.addEventListener('DOMContentLoaded', async () => {
            await loadBranches(); // Populates branchesData and dropdowns
            await loadTimeSlots();
            await loadHolidays();
        });
    </script>
</body>

</html>